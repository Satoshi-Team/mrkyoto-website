<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Weather Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #ddd; }
        .test-section.pending { background: #fff3cd; border-left-color: #ffc107; }
        .test-section.success { background: #d4edda; border-left-color: #28a745; }
        .test-section.error { background: #f8d7da; border-left-color: #dc3545; }
        .test-section.running { background: #d1ecf1; border-left-color: #17a2b8; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s ease; }
        .weather-display { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .weather-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .weather-item { text-align: center; }
        .weather-value { font-size: 24px; font-weight: bold; }
        .weather-label { font-size: 12px; opacity: 0.8; }
        #console { background: #f8f9fa; padding: 15px; margin-top: 20px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; }
        .summary { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üå§Ô∏è Automated Weather Test Suite</h1>
        
        <div class="summary">
            <h3>Test Summary</h3>
            <div>Total Tests: <span id="total-tests">0</span></div>
            <div>Passed: <span id="passed-tests">0</span></div>
            <div>Failed: <span id="failed-tests">0</span></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="test-section pending" id="test-1">
            <h3>üåê Test 1: Direct API Call</h3>
            <div>Testing direct connection to Open-Meteo API...</div>
        </div>
        
        <div class="test-section pending" id="test-2">
            <h3>üé• Test 2: Weather Service Loading</h3>
            <div>Testing weather service script loading...</div>
        </div>
        
        <div class="test-section pending" id="test-3">
            <h3>üå§Ô∏è Test 3: Weather Data Retrieval</h3>
            <div>Testing weather data fetching and parsing...</div>
        </div>
        
        <div class="test-section pending" id="test-4">
            <h3>üéØ Test 4: Live Widget Integration</h3>
            <div>Testing live widget initialization...</div>
        </div>
        
        <div class="weather-display" id="weather-display" style="display: none;">
            <h2>üå§Ô∏è Kyoto Weather Data</h2>
            <div class="weather-grid">
                <div class="weather-item">
                    <div class="weather-value" id="temp">--¬∞C</div>
                    <div class="weather-label">Temperature</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="feels-like">--¬∞C</div>
                    <div class="weather-label">Feels Like</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="humidity">--%</div>
                    <div class="weather-label">Humidity</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="wind">-- km/h</div>
                    <div class="weather-label">Wind Speed</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="pressure">-- hPa</div>
                    <div class="weather-label">Pressure</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="description">--</div>
                    <div class="weather-label">Conditions</div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: center; font-size: 14px; opacity: 0.8;">
                Source: <span id="source">--</span> | Last Updated: <span id="last-updated">--</span>
            </div>
        </div>
        
        <div id="console">
            <div>üöÄ Automated weather test suite starting...</div>
        </div>
    </div>

    <script>
        let testResults = {
            total: 4,
            passed: 0,
            failed: 0,
            weatherData: null
        };

        function log(message) {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function updateTestStatus(testId, status, message) {
            const testElement = document.getElementById(testId);
            testElement.className = `test-section ${status}`;
            testElement.querySelector('div').textContent = message;
            
            if (status === 'success') testResults.passed++;
            if (status === 'error') testResults.failed++;
            
            updateSummary();
        }

        function updateSummary() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
            
            const progress = (testResults.passed + testResults.failed) / testResults.total * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        function updateWeatherDisplay(data) {
            document.getElementById('weather-display').style.display = 'block';
            document.getElementById('temp').textContent = `${data.temperature}¬∞C`;
            document.getElementById('feels-like').textContent = `${data.feelsLike}¬∞C`;
            document.getElementById('humidity').textContent = `${data.humidity}%`;
            document.getElementById('wind').textContent = `${data.windSpeed} km/h`;
            document.getElementById('pressure').textContent = `${data.pressure} hPa`;
            document.getElementById('description').textContent = data.description;
            document.getElementById('source').textContent = data.source;
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }

        async function testDirectAPI() {
            log('üåê Testing direct API call...');
            updateTestStatus('test-1', 'running', 'Testing direct connection to Open-Meteo API...');
            
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.0116&longitude=135.7681&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,pressure_msl&timezone=auto');
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Direct API call successful');
                    log(`üå°Ô∏è Temperature: ${data.current.temperature_2m}¬∞C`);
                    log(`üíß Humidity: ${data.current.relative_humidity_2m}%`);
                    log(`üí® Wind: ${data.current.wind_speed_10m} km/h`);
                    log(`üå°Ô∏è Pressure: ${data.current.pressure_msl} hPa`);
                    
                    updateTestStatus('test-1', 'success', '‚úÖ Direct API call successful!');
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Direct API error: ${error.message}`);
                updateTestStatus('test-1', 'error', `‚ùå Direct API failed: ${error.message}`);
                return null;
            }
        }

        async function testWeatherService() {
            log('üé• Testing weather service loading...');
            updateTestStatus('test-2', 'running', 'Loading weather service script...');
            
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.src = '/js/weather-service.js';
                
                script.onload = () => {
                    log('‚úÖ Weather service script loaded');
                    
                    if (window.WeatherService) {
                        log('‚úÖ WeatherService class available');
                        updateTestStatus('test-2', 'success', '‚úÖ Weather service loaded successfully!');
                        resolve(true);
                    } else {
                        log('‚ùå WeatherService class not available');
                        updateTestStatus('test-2', 'error', '‚ùå WeatherService class not available');
                        resolve(false);
                    }
                };
                
                script.onerror = () => {
                    log('‚ùå Failed to load weather service script');
                    updateTestStatus('test-2', 'error', '‚ùå Failed to load weather service script');
                    resolve(false);
                };
                
                document.head.appendChild(script);
            });
        }

        async function testWeatherData() {
            log('üå§Ô∏è Testing weather data retrieval...');
            updateTestStatus('test-3', 'running', 'Fetching and parsing weather data...');
            
            try {
                const weatherService = new WeatherService();
                const weatherData = await weatherService.getKyotoWeather();
                
                if (weatherData && weatherData.temperature !== undefined) {
                    log('‚úÖ Weather data retrieved successfully');
                    log(`üå°Ô∏è Temperature: ${weatherData.temperature}¬∞C`);
                    log(`üíß Humidity: ${weatherData.humidity}%`);
                    log(`üí® Wind: ${weatherData.windSpeed} km/h`);
                    log(`üå°Ô∏è Pressure: ${weatherData.pressure} hPa`);
                    log(`üå§Ô∏è Description: ${weatherData.description}`);
                    log(`üì° Source: ${weatherData.source}`);
                    
                    updateWeatherDisplay(weatherData);
                    updateTestStatus('test-3', 'success', '‚úÖ Weather data retrieved successfully!');
                    testResults.weatherData = weatherData;
                    return true;
                } else {
                    throw new Error('Invalid weather data returned');
                }
            } catch (error) {
                log(`‚ùå Weather data error: ${error.message}`);
                updateTestStatus('test-3', 'error', `‚ùå Weather data failed: ${error.message}`);
                return false;
            }
        }

        async function testLiveWidget() {
            log('üéØ Testing live widget integration...');
            updateTestStatus('test-4', 'running', 'Testing live widget initialization...');
            
            try {
                // Load live widget script
                const script = document.createElement('script');
                script.src = '/js/live-kyoto-widget.js';
                
                return new Promise((resolve) => {
                    script.onload = () => {
                        log('‚úÖ Live widget script loaded');
                        
                        // Check if widget initializes
                        setTimeout(() => {
                            if (window.liveKyotoWidget) {
                                log('‚úÖ Live widget initialized');
                                updateTestStatus('test-4', 'success', '‚úÖ Live widget integration successful!');
                                resolve(true);
                            } else {
                                log('‚ùå Live widget not initialized');
                                updateTestStatus('test-4', 'error', '‚ùå Live widget failed to initialize');
                                resolve(false);
                            }
                        }, 1000);
                    };
                    
                    script.onerror = () => {
                        log('‚ùå Failed to load live widget script');
                        updateTestStatus('test-4', 'error', '‚ùå Failed to load live widget script');
                        resolve(false);
                    };
                    
                    document.head.appendChild(script);
                });
            } catch (error) {
                log(`‚ùå Live widget error: ${error.message}`);
                updateTestStatus('test-4', 'error', `‚ùå Live widget failed: ${error.message}`);
                return false;
            }
        }

        async function runAllTests() {
            log('üöÄ Starting automated weather test suite...');
            
            // Test 1: Direct API
            const apiData = await testDirectAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 2: Weather Service
            const serviceLoaded = await testWeatherService();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 3: Weather Data
            if (serviceLoaded) {
                await testWeatherData();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Test 4: Live Widget
            await testLiveWidget();
            
            // Final summary
            setTimeout(() => {
                log('üèÅ Test suite completed!');
                log(`üìä Results: ${testResults.passed}/${testResults.total} tests passed`);
                
                if (testResults.passed === testResults.total) {
                    log('üéâ All tests passed! Weather functionality is working correctly.');
                } else {
                    log('‚ö†Ô∏è Some tests failed. Check the results above for details.');
                }
            }, 1000);
        }

        // Start tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html> 